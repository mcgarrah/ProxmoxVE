{
    "name": "PowerDNS",
    "slug": "powerdns",
    "categories": [
        5
    ],
    "date_created": "2025-11-12",
    "type": "ct",
    "updateable": true,
    "privileged": false,
    "interface_port": 8081,
    "web_interface_port": 9443,
    "documentation": "https://docs.powerdns.com/",
    "website": "https://www.powerdns.com/",
    "logo": "https://www.powerdns.com/hs-fs/hubfs/logo-footer.jpg",
    "config_path": "/etc/powerdns/pdns.conf",
    "description": "Create a container with PowerDNS installed. Options for authoritative (sqlite), recursor, or both. When both services are installed, authoritative uses port 53 and recursor uses port 5353 to avoid conflicts. Useful for split DNS setups and simple recursive resolvers.",
    "default_os": "debian",
    "default_version": "12",
    "options": {
        "role": {
            "type": "string",
            "enum": [
                "authoritative",
                "recursor",
                "both"
            ],
            "default": "authoritative",
            "description": "Role to install in the container: authoritative server, recursor, or both."
        },
        "disk": {
            "type": "integer",
            "default": 4
        },
        "cpu": {
            "type": "integer",
            "default": 1
        },
        "ram": {
            "type": "integer",
            "default": 512
        },
        "install_webui": {
            "type": "boolean",
            "default": false,
            "description": "Install PowerDNS-Admin web interface for easier DNS management (requires 1GB+ RAM, adds ~500MB disk). Accessible via HTTPS on port 9443."
        },
        "pdns_web_bind": {
            "type": "string",
            "enum": [
                "127.0.0.1",
                "0.0.0.0"
            ],
            "default": "0.0.0.0",
            "description": "PowerDNS API bind address. Use 0.0.0.0 for external access (secured with API key), 127.0.0.1 for localhost only."
        },
        "private_zone": {
            "type": "string",
            "default": "home.local",
            "description": "Private zone to create automatically (authoritative only). Leave empty to skip."
        },
        "public_zone": {
            "type": "string",
            "default": "",
            "description": "Public zone to create automatically (authoritative only). Leave empty to skip."
        },
        "recursor_allow": {
            "type": "string",
            "default": "192.168.0.0/16",
            "description": "Networks allowed to query the recursor (CIDR format)."
        },
        "forward_choice": {
            "type": "boolean",
            "default": false,
            "description": "Configure zone forwarding from recursor to authoritative server."
        },
        "forward_domain": {
            "type": "string",
            "default": "",
            "description": "Domain to forward (if forwarding enabled)."
        },
        "forward_ip": {
            "type": "string",
            "default": "",
            "description": "IP address to forward domain queries to (if forwarding enabled)."
        }
    },
    "interactive_prompts": [
        {
            "name": "PowerDNS Role Selection",
            "description": "Choose installation type",
            "prompt": "Install PowerDNS as (a)uthoritative, (r)ecursor, or (b)oth? [a/r/b]",
            "default": "a"
        },
        {
            "name": "Web Interface Installation",
            "description": "Install PowerDNS-Admin web interface (authoritative only)",
            "prompt": "Install PowerDNS-Admin web interface? [y/N]",
            "default": "N",
            "conditional": "role == 'a' || role == 'b'"
        },
        {
            "name": "API Bind Address",
            "description": "PowerDNS API network binding",
            "prompt": "Bind PowerDNS API to all interfaces (0.0.0.0) or localhost only (127.0.0.1)? [0.0.0.0/127.0.0.1]",
            "default": "0.0.0.0",
            "conditional": "install_webui == 'y' || install_webui == 'yes'"
        },
        {
            "name": "Private Zone Creation",
            "description": "Create default private zone (authoritative only)",
            "prompt": "Create private zone? Enter zone name or press Enter to skip [home.local]",
            "default": "home.local",
            "conditional": "role == 'a' || role == 'b'"
        },
        {
            "name": "Public Zone Creation",
            "description": "Create public zone (authoritative only)",
            "prompt": "Create public zone? Enter zone name or press Enter to skip []",
            "default": "",
            "conditional": "role == 'a' || role == 'b'"
        },
        {
            "name": "Recursor Allow Networks",
            "description": "Networks allowed to query recursor",
            "prompt": "Enter allowed networks for recursor queries [192.168.0.0/16]",
            "default": "192.168.0.0/16",
            "conditional": "role == 'r' || role == 'b'"
        },
        {
            "name": "Zone Forwarding",
            "description": "Configure zone forwarding (recursor only)",
            "prompt": "Configure zone forwarding to authoritative server? [y/N]",
            "default": "N",
            "conditional": "role == 'r' || role == 'b'"
        }
    ],
    "examples": [
        {
            "title": "Interactive creation",
            "command": "bash ct/powerdns.sh",
            "notes": "Run the wrapper and choose settings in the interactive menu."
        },
        {
            "title": "Non-interactive with environment variables",
            "command": "var_hostname=powerdns var_ctid=150 var_cpu=1 var_ram=512 var_disk=4 var_os=debian var_version=12 bash ct/powerdns.sh",
            "notes": "Prefill common variables and run the wrapper non-interactively."
        },
        {
            "title": "Install with PowerDNS-Admin web interface",
            "command": "INSTALL_WEBUI=yes var_hostname=powerdns var_ctid=150 var_ram=1024 bash ct/powerdns.sh",
            "notes": "Install PowerDNS with the PowerDNS-Admin web interface for easier management. Requires 1GB+ RAM."
        }
    ],
    "notes": [
        {
            "text": "Authoritative mode installs pdns-server + pdns-backend-sqlite3 and exposes the PowerDNS API/webserver on port 8081 by default. The installer generates an API key and writes it to /etc/powerdns/pdns.conf.",
            "type": "info"
        },
        {
            "text": "Recursor mode installs pdns-recursor and writes a minimal /etc/powerdns/recursor.conf (local-address, allow-from, forward-zones). Update allow-from and forward-zones to implement split-DNS forwarding to internal authoritative servers.",
            "type": "info"
        },
        {
            "text": "To retrieve the generated API key, run `pct exec <CTID> -- grep api-key /etc/powerdns/pdns.conf` on the Proxmox host.",
            "type": "info"
        },
        {
            "text": "For Proxmox SDN integration, the API must be reachable. Set `PDNS_WEB_BIND=0.0.0.0` during install or manually edit `/etc/powerdns/pdns.conf` to change `webserver-address` from `127.0.0.1` to `0.0.0.0` and restart the `pdns` service.",
            "type": "warning"
        },
        {
            "text": "Production recommendation: for larger or HA deployments use a MySQL/Postgres backend (not sqlite) and consider the official PowerDNS APT repositories for timely updates.",
            "type": "info"
        },
        {
            "text": "Security: PDNS_WEB_BIND defaults to 0.0.0.0 for convenience but is secured with API key authentication. For additional security, set to 127.0.0.1 for localhost-only access.",
            "type": "warning"
        },
        {
            "text": "PowerDNS-Admin web interface: Set INSTALL_WEBUI=yes to install the PowerDNS-Admin web interface accessible via HTTPS on port 9443. The service binds to localhost only and is proxied through nginx with TLS. Default credentials are admin/admin (change after first login). Requires 1GB+ RAM and adds ~500MB disk space.",
            "type": "info"
        },
        {
            "text": "Port configuration: When both authoritative and recursor are installed together, authoritative server runs on port 53 and recursor on port 5353 to prevent conflicts. PowerDNS API runs on HTTPS port 8443 (nginx proxy) and HTTP port 8081 (localhost). PowerDNS-Admin web interface runs on HTTPS port 9443 (nginx proxy) and HTTP port 9191 (localhost only).",
            "type": "info"
        },

    ],
    "long_description": "This feature creates a Debian-based LXC that installs PowerDNS. The installer supports authoritative (sqlite), recursor, or both roles. It's intended for small/home deployments and testing; for production see notes about backends and security.",
    "quick_notes": [
        "Authoritative mode uses sqlite by default for simplicity. For production or HA setups, consider MySQL/Postgres backends and add database configuration options.",
        "Recursor installs pdns-recursor and writes a minimal /etc/powerdns/recursor.conf with local-address and allow-from. The recursor can forward specific domains to an authoritative server using forward-zones.",
        "Port separation: Both services together use authoritative (port 53) and recursor (port 5353) to avoid conflicts."
    ],
    "additional_examples": [
        {
            "title": "Expose PDNS webserver (dangerous)",
            "command": "PDNS_WEB_BIND=0.0.0.0 ROLE=authoritative bash ct/powerdns.sh",
            "notes": "Exposes the PowerDNS API/webserver on all interfaces. Only use with firewall/proxy protection."
        },
        {
            "title": "Check services from host (replace CTID)",
            "command": "pct exec CTID -- systemctl status pdns && pct exec CTID -- systemctl status pdns-recursor && pct exec CTID -- pdnsutil list-zones",
            "notes": "Verify services and sample zones. API available on HTTP (configurable interface:8081) secured with API key."
        },
        {
            "title": "Access PowerDNS-Admin web interface",
            "command": "https://container-ip:9443",
            "notes": "If INSTALL_WEBUI=yes was used, access the HTTPS web interface with admin/admin credentials. Self-signed certificate will show browser warning."
        }
    ],
    "inside_container": {
        "authoritative": "Manage zones with pdnsutil (e.g. pdnsutil create-zone example.local ns1.example.local). Config is at /etc/powerdns/pdns.conf (API key is generated by the installer and webserver listens on port 8081 by default).",
        "recursor": "Edit /etc/powerdns/recursor.conf to update allow-from networks or forward-zones entries for split DNS. When both services are installed, recursor runs on port 5353.",
        "web_interface": "If PowerDNS-Admin is installed, access it at https://container-ip:9443 with default credentials admin/admin. Uses HTTPS with self-signed certificate. Change password after first login."
    },
    "install_methods": [
        {
            "type": "default",
            "script": "ct/powerdns.sh",
            "resources": {
                "cpu": 1,
                "ram": 512,
                "hdd": 4,
                "os": "debian",
                "version": "12"
            }
        }
    ],
    "default_credentials": {
        "username": null,
        "password": null,
        "web_interface": {
            "username": "admin",
            "password": "admin",
            "note": "Only if PowerDNS-Admin is installed (INSTALL_WEBUI=yes). Access via HTTPS on port 9443. Change after first login."
        }
    },
    "web_binding": {
        "default_bind": "0.0.0.0",
        "env_var": "PDNS_WEB_BIND",
        "example_expose": "PDNS_WEB_BIND=0.0.0.0 ROLE=authoritative bash ct/powerdns.sh",
        "warning": "Binding to 0.0.0.0 exposes the PDNS API and webserver to any network the container can reach. Even with an API key, this is a security risk on untrusted networks. Use firewall rules, bind to a specific management interface, or run behind a reverse proxy with TLS/auth. PowerDNS-Admin always binds to localhost only and is accessed via HTTPS proxy on port 9443."
    },
    "suggested_followups": [
        "Add support for MySQL/Postgres backends for larger deployments.",
        "Optionally add a check for the PowerDNS official repos if newer versions are required.",
        "Consider Let's Encrypt integration for production TLS certificates."
    ],
    "contribution": "Follow the repository contribution guidelines and style in other ct/ and install/ scripts. Keep functions and messages consistent with misc/build.func."
}
